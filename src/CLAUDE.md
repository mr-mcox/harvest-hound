# Harvest Hound - src/

## Quick Start

### Development Mode
```bash
./dev
```
Starts both backend (FastAPI) and frontend (SvelteKit) with hot reload.
- Backend: http://localhost:8000
- Frontend: http://localhost:5173 (proxies /api/* to backend)

### Production Build
```bash
cd frontend && npm run build
```
Outputs static files to `backend/static/`.

### Production Run
```bash
cd backend && uv run uvicorn app:app
```
Serves both API and built frontend at http://localhost:8000.

## Project Structure

```
src/
  dev              # Development script (runs both services)
  backend/
    app.py         # FastAPI entrypoint
    routes.py      # API endpoints
    models.py      # SQLModel database setup
    migrations/    # Alembic database migrations
    baml_functions.py  # BAML wrapper functions
    baml_src/      # BAML prompt definitions
    baml_client/   # Generated BAML client (do not edit)
    static/        # Built frontend (generated by npm run build)
  frontend/
    src/routes/    # SvelteKit pages
    src/app.css    # Tailwind + Skeleton styles
```

## Key Endpoints

- `GET /api/hello` - Health check with DB status
- `GET /api/dishes?ingredient=X` - Get dish suggestions (BAML/LLM)
- `GET /api/dishes/stream?ingredient=X` - Stream dish suggestions (SSE)

## Environment Variables

- `ANTHROPIC_HH_API_KEY` - Required for BAML/LLM features
- `DATABASE_URL` - Database connection (default: `sqlite:///dev.db`)
  - Dev: `sqlite:///dev.db` (default, safe for testing)
  - Live: `sqlite:///harvest.db` (production data)

## Database Migrations

Database schema changes are managed with Alembic.

### Creating a Migration

After modifying models in `models.py`:

```bash
cd backend
uv run alembic revision --autogenerate -m "description_of_change"
```

This generates a migration file in `migrations/versions/`. Review it before applying.

### Applying Migrations

**Development database (dev.db):**
```bash
cd backend
uv run alembic upgrade head
```

**Live database (harvest.db):**
```bash
cd backend
DATABASE_URL=sqlite:///harvest.db uv run alembic upgrade head
```

### Migration History

```bash
cd backend
uv run alembic current     # Show current version
uv run alembic history     # Show migration history
uv run alembic downgrade -1  # Rollback one migration (use with caution!)
```

**Important**: Always backup `harvest.db` before running migrations on live data.

## Code Quality

### Pre-commit Hooks

Run before committing (automatic) or manually:
```bash
pre-commit run --all-files
```

Checks:
- **ruff**: Python linting + formatting (line-length 88, complexity limit 10)
- **prettier**: Frontend formatting (Svelte, TS, CSS)
- **svelte-check**: TypeScript type checking

### Frontend Scripts
```bash
cd frontend
npm run format      # Auto-format with prettier
npm run format:check  # Check formatting
npm run check       # TypeScript/Svelte type checking
npm run lint        # All checks
```

### Backend
```bash
cd backend
uv run ruff check --fix .  # Lint and auto-fix
uv run ruff format .       # Format
```

**Note**: Run `pre-commit run --all-files` at the end of each implementation phase to catch issues early.
